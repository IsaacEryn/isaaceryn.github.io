<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>rAF + Scroll - A11y | Scroll-Driven Animation</title>
		<link rel="stylesheet" href="../styles/common.css" />
		<link rel="stylesheet" href="../styles/demo.css" />
		<style>
			.demo--raf .hero__cover,
			.demo--raf .feature-card,
			.demo--raf .stat-card {
				transition: none;
			}

			/* Locked state */
			.feature-card.is-locked,
			.stat-card.is-locked {
				opacity: 1 !important;
				transform: none !important;
			}

			/* Better focus */
			a:focus-visible,
			button:focus-visible {
				outline: 3px solid var(--accent);
				outline-offset: 4px;
			}

			/* Better contrast */
			.page-header__desc,
			.feature-card p,
			.stat-card__label {
				color: #b8c5d6;
			}
		</style>
	</head>
	<body class="demo--raf demo--a11y">
		<a class="skip-link" href="#main">Skip to content</a>

		<!-- Progress Bar -->
		<div class="progress-bar" aria-hidden="true">
			<div class="progress-bar__fill"></div>
		</div>

		<!-- Header -->
		<header class="page-header container">
			<a href="../index.html" class="page-header__back">â† Back to demos</a>
			<h1 class="page-header__title">rAF + Scroll - Accessible</h1>
			<p class="page-header__desc">
				Elements lock in place after appearing. Respects <code>prefers-reduced-motion</code>.
				<br /><span lang="ko">(ìš”ì†Œê°€ ë‚˜íƒ€ë‚œ í›„ ê³ ì •ë©ë‹ˆë‹¤. ëª¨ì…˜ ê°ì†Œ ì„¤ì •ì„ ì¡´ì¤‘í•©ë‹ˆë‹¤.)</span>
			</p>
			<span class="tag">Progressive + A11y</span>
		</header>

		<!-- Main Content -->
		<main id="main">
			<!-- Hero Section -->
			<section class="hero" data-raf-hero aria-label="Hero introduction">
				<div class="hero__sticky">
					<div class="hero__frame">
						<div class="hero__layer hero__base">
							<h2>Accessible rAF</h2>
							<p>
								Once revealed, the cover stays up permanently.
								<br /><span lang="ko">(í•œ ë²ˆ ì—´ë¦¬ë©´ ì»¤ë²„ê°€ ì˜êµ¬ì ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.)</span>
							</p>
						</div>
						<div class="hero__layer hero__cover">
							<h2>Scroll Down</h2>
							<p>
								One-time reveal animation.
								<br /><span lang="ko">(ì¼íšŒì„± ê³µê°œ ì• ë‹ˆë©”ì´ì…˜.)</span>
							</p>
						</div>
					</div>
				</div>
			</section>

			<!-- Features Section -->
			<section class="features" aria-label="Accessibility features">
				<div class="container">
					<header class="features__header">
						<h2>A11y Features</h2>
						<p>
							Cards stay visible after first appearance.
							<br /><span lang="ko">(ì¹´ë“œê°€ ì²˜ìŒ ë‚˜íƒ€ë‚œ í›„ ê³„ì† ìœ ì§€ë©ë‹ˆë‹¤.)</span>
						</p>
					</header>
					<div class="features__grid">
						<article class="feature-card" data-raf-card>
							<div class="feature-card__icon" aria-hidden="true">ğŸ¯</div>
							<h3>Threshold Lock</h3>
							<p>
								Stop updating elements after reaching 100% visibility.
								<br /><span lang="ko">(100% ê°€ì‹œì„± ë„ë‹¬ í›„ ì—…ë°ì´íŠ¸ ì¤‘ì§€.)</span>
							</p>
						</article>
						<article class="feature-card" data-raf-card>
							<div class="feature-card__icon" aria-hidden="true">ğŸ”‹</div>
							<h3>Battery Saving</h3>
							<p>
								Locked elements reduce CPU usage.
								<br /><span lang="ko">(ê³ ì •ëœ ìš”ì†ŒëŠ” CPU ì‚¬ìš©ëŸ‰ ê°ì†Œ.)</span>
							</p>
						</article>
						<article class="feature-card" data-raf-card>
							<div class="feature-card__icon" aria-hidden="true">â™¿</div>
							<h3>Motion Safe</h3>
							<p>
								Instant reveal if user prefers reduced motion.
								<br /><span lang="ko">(ëª¨ì…˜ ê°ì†Œ ì„ í˜¸ ì‹œ ì¦‰ì‹œ í‘œì‹œ.)</span>
							</p>
						</article>
					</div>
				</div>
			</section>

			<!-- Stats Section -->
			<section class="stats" aria-label="Statistics">
				<div class="container">
					<header class="stats__header">
						<h2>Performance</h2>
						<p>
							Counters lock at target value.
							<br /><span lang="ko">(ì¹´ìš´í„°ê°€ ëª©í‘œ ê°’ì—ì„œ ê³ ì •ë©ë‹ˆë‹¤.)</span>
						</p>
					</header>
					<div class="stats__grid">
						<div class="stat-card" data-raf-stat data-value="0">
							<div class="stat-card__value">?</div>
							<div class="stat-card__label">CPU After Lock</div>
						</div>
						<div class="stat-card" data-raf-stat data-value="100">
							<div class="stat-card__value">0%</div>
							<div class="stat-card__label">Accessible</div>
						</div>
						<div class="stat-card" data-raf-stat data-value="1">
							<div class="stat-card__value">0</div>
							<div class="stat-card__label">Flicker Events</div>
						</div>
					</div>
				</div>
			</section>

			<!-- Implementation Info -->
			<section class="impl-info" aria-label="Implementation details">
				<div class="container">
					<div class="impl-info__grid">
						<div class="impl-info__box">
							<h3>A11y Implementation</h3>
							<ul>
								<li>Track which elements have reached threshold</li>
								<li>Add <code>.is-locked</code> class to freeze state</li>
								<li>Skip calculations for locked elements</li>
								<li>Check <code>prefers-reduced-motion</code> first</li>
							</ul>
						</div>
						<div class="impl-info__box">
							<h3>Performance Gains</h3>
							<ul>
								<li>Fewer DOM updates as page loads</li>
								<li>No recalculations for visible content</li>
								<li>Eventually zero animations running</li>
								<li>Better battery life on mobile</li>
							</ul>
						</div>
						<div class="impl-info__box">
							<h3>Best Practices</h3>
							<ul>
								<li>Always check motion preferences</li>
								<li>Provide instant fallback</li>
								<li>Use semantic HTML</li>
								<li>Test with screen readers</li>
							</ul>
						</div>
					</div>
				</div>
			</section>
		</main>

		<!-- Footer -->
		<footer class="page-footer">
			<div class="container">
				<p>Scroll-Driven Animation Demo - Accessible Version</p>
			</div>
		</footer>

		<script>
			(function () {
				const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

				const progressFill = document.querySelector('.progress-bar__fill');
				const heroCover = document.querySelector('.hero__cover');
				const heroSection = document.querySelector('[data-raf-hero]');
				const cards = document.querySelectorAll('[data-raf-card]');
				const stats = document.querySelectorAll('[data-raf-stat]');

				let ticking = false;
				let heroLocked = false;
				const lockedCards = new Set();
				const lockedStats = new Set();

				const clamp = (val) => Math.min(1, Math.max(0, val));
				const easeOut = (t) => 1 - Math.pow(1 - t, 3);

				// If reduced motion, show everything immediately
				if (prefersReducedMotion) {
					heroCover.style.transform = 'translateY(-100%)';
					cards.forEach(card => {
						card.style.opacity = '1';
						card.style.transform = 'none';
						card.classList.add('is-locked');
					});
					stats.forEach(stat => {
						stat.style.opacity = '1';
						stat.style.transform = 'none';
						stat.classList.add('is-locked');

						const label = stat.querySelector('.stat-card__label').textContent;
						const valueEl = stat.querySelector('.stat-card__value');
						const target = parseFloat(stat.dataset.value);

						if (label.includes('CPU')) valueEl.textContent = '0%';
						else if (label.includes('Accessible')) valueEl.textContent = '100%';
						else if (label.includes('Flicker')) valueEl.textContent = '0';
					});
					return;
				}

				function update() {
					ticking = false;
					const vh = window.innerHeight;
					const scrollY = window.scrollY;
					const docHeight = document.documentElement.scrollHeight - vh;

					// Progress bar
					const scrollProgress = docHeight > 0 ? scrollY / docHeight : 0;
					progressFill.style.transform = `scaleX(${scrollProgress})`;

					// Hero cover - locks when fully revealed
					if (!heroLocked && heroSection) {
						const heroRect = heroSection.getBoundingClientRect();
						const heroProgress = clamp(-heroRect.top / (heroRect.height - vh));
						const coverY = easeOut(heroProgress) * -100;
						heroCover.style.transform = `translateY(${coverY}%)`;

						if (heroProgress >= 0.95) {
							heroLocked = true;
							heroCover.style.transform = 'translateY(-100%)';
						}
					}

					// Feature cards - lock when fully visible
					cards.forEach((card, index) => {
						if (lockedCards.has(index)) return;

						const rect = card.getBoundingClientRect();
						const start = vh * 0.85;
						const end = vh * 0.4;
						const progress = clamp((start - rect.top) / (start - end));
						const eased = easeOut(progress);

						card.style.opacity = eased;
						card.style.transform = `translateY(${(1 - eased) * 60}px)`;

						if (progress >= 0.95) {
							card.style.opacity = '1';
							card.style.transform = 'none';
							card.classList.add('is-locked');
							lockedCards.add(index);
						}
					});

					// Stat cards - lock when fully visible
					stats.forEach((stat, index) => {
						if (lockedStats.has(index)) return;

						const rect = stat.getBoundingClientRect();
						const start = vh * 0.8;
						const end = vh * 0.35;
						const progress = clamp((start - rect.top) / (start - end));
						const eased = easeOut(progress);

						stat.style.opacity = eased;
						stat.style.transform = `scale(${0.9 + eased * 0.1})`;

						// Counter
						const target = parseFloat(stat.dataset.value);
						const current = Math.round(target * eased);
						const label = stat.querySelector('.stat-card__label').textContent;
						const valueEl = stat.querySelector('.stat-card__value');

						if (label.includes('CPU')) valueEl.textContent = current === 0 ? '0%' : '...';
						else if (label.includes('Accessible')) valueEl.textContent = current + '%';
						else if (label.includes('Flicker')) valueEl.textContent = current;

						if (progress >= 0.95) {
							stat.style.opacity = '1';
							stat.style.transform = 'none';
							stat.classList.add('is-locked');
							lockedStats.add(index);

							// Set final values
							if (label.includes('CPU')) valueEl.textContent = '0%';
							else if (label.includes('Accessible')) valueEl.textContent = '100%';
							else if (label.includes('Flicker')) valueEl.textContent = '0';
						}
					});
				}

				function onScroll() {
					if (!ticking) {
						ticking = true;
						requestAnimationFrame(update);
					}
				}

				window.addEventListener('scroll', onScroll, { passive: true });
				window.addEventListener('resize', onScroll, { passive: true });
				update();
			})();
		</script>
	</body>
</html>
